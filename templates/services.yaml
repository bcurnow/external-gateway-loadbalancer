{{- if .Values.externalServices }}
{{- range .Values.externalServices }}
{{- $service := . }}
{{- $shouldLoadBalance := .loadBalanceAcrossEndpoints | default true }}
{{- if and $shouldLoadBalance (gt (len .endpoints) 1) }}
{{/* Create a separate ExternalName service for each endpoint when load balancing across endpoints */}}
{{- range $index, $endpoint := .endpoints }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $service.name }}-{{ $index }}
  namespace: {{ $service.namespace | default $.Release.Namespace }}
  labels:
    {{- include "external-gateway-loadbalancer.labels" $ | nindent 4 }}
    app.kubernetes.io/component: external-service
    app.kubernetes.io/part-of: {{ $service.name }}
    endpoint-index: "{{ $index }}"
    {{- with $service.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    description: {{ printf "%s (endpoint %d of %d: %s)" $service.description ($index | add1) (len $service.endpoints) $endpoint | quote }}
    {{- with $.Values.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with $service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: ExternalName
  externalName: {{ $endpoint }}
  ports:
    - name: {{ $service.protocol | lower }}
      port: {{ $service.port }}
      protocol: TCP
      targetPort: {{ $service.port }}
  sessionAffinity: None
{{- end }}
{{- else }}
{{/* Create single ExternalName service using first endpoint */}}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ $service.name }}
  namespace: {{ $service.namespace | default $.Release.Namespace }}
  labels:
    {{- include "external-gateway-loadbalancer.labels" $ | nindent 4 }}
    app.kubernetes.io/component: external-service
    {{- with $service.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  annotations:
    description: {{ $service.description | quote }}
    {{- with $.Values.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
    {{- with $service.annotations }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
spec:
  type: ExternalName
  externalName: {{ index $service.endpoints 0 }}
  ports:
    - name: {{ $service.protocol | lower }}
      port: {{ $service.port }}
      protocol: TCP
      targetPort: {{ $service.port }}
  sessionAffinity: None
{{- end }}
{{- end }}
{{- end }}
