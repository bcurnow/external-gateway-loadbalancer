{{- if gt (len (.Values.routes | default list)) 0 }}
{{/* Custom routes provided (non-empty list) - use them as-is */}}
{{- range .Values.routes }}
{{- $route := . }}
{{- $releaseNamespace := $.Release.Namespace }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $route.name }}
  namespace: {{ $route.namespace | default $releaseNamespace }}
  labels:
    {{- include "external-gateway-loadbalancer.labels" $ | nindent 4 }}
    app.kubernetes.io/component: http-route
    {{- with $route.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- $annotations := merge ($.Values.annotations | default dict) ($route.annotations | default dict) }}
  {{- with $annotations }}
  annotations:
    description: {{ $route.description | quote }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  parentRefs:
    - name: {{ $route.gateway }}
      {{- if ne ($route.namespace | default $releaseNamespace) ($.Values.gateway.namespace | default $releaseNamespace) }}
      namespace: {{ $.Values.gateway.namespace | default $releaseNamespace }}
      {{- end }}
  {{- if $route.hostnames }}
  hostnames:
    {{- range $route.hostnames }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}
  rules:
    {{- range $route.rules }}
    - {{- if .matches }}
        matches:
          {{- range .matches }}
          - {{- if .path }}
              path:
                type: {{ .path.type }}
                value: {{ .path.value }}
              {{- end }}
                {{- if .method }}
                method: {{ .method }}
              {{- end }}
                {{- if .headers }}
                headers:
                  {{- range .headers }}
                  - name: {{ .name }}
                    value: {{ .value }}
                  {{- end }}
                {{- end }}
            {{- end }}
        {{- end }}
        backendRefs:
          {{- range .backendRefs }}
          {{- $backendRef := . }}
          {{- $serviceName := .name }}
          {{/* Find the service definition to check if it has multiple endpoints */}}
          {{- $service := index $.Values.externalServices 0 }}
          {{- range $.Values.externalServices }}
            {{- if eq .name $serviceName }}
              {{- $service = . }}
            {{- end }}
          {{- end }}
          {{- $shouldLoadBalance := $service.loadBalanceAcrossEndpoints | default true }}
          {{/* If service has multiple endpoints and load balancing is enabled, create weighted refs */}}
          {{- if and $shouldLoadBalance (gt (len $service.endpoints) 1) }}
            {{- $endpointCount := len $service.endpoints }}
            {{- range $index, $endpoint := $service.endpoints }}
          - name: {{ $serviceName }}-{{ $index }}
            port: {{ $backendRef.port }}
            weight: {{ if $backendRef.weight }}{{ $backendRef.weight }}{{ else }}{{ div 100 $endpointCount }}{{ end }}
            {{- end }}
          {{- else }}
          - name: {{ $serviceName }}
            port: {{ $backendRef.port }}
            {{- if $backendRef.weight }}
            weight: {{ $backendRef.weight }}
            {{- end }}
          {{- end }}
          {{- end }}
    {{- end }}
{{- end }}
{{- else if .Values.externalServices }}
{{/* Auto-generate default routes from externalServices */}}
{{- range .Values.externalServices }}
{{- $service := . }}
{{- $releaseNamespace := $.Release.Namespace }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $service.name }}-route
  namespace: {{ $releaseNamespace }}
  labels:
    {{- include "external-gateway-loadbalancer.labels" $ | nindent 4 }}
    app.kubernetes.io/component: http-route
    generated: "true"
    {{- with $service.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- $annotations := merge ($.Values.annotations | default dict) ($service.annotations | default dict) }}
  {{- with $annotations }}
  annotations:
    description: "Auto-generated route for {{ $service.name }}"
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  parentRefs:
    - name: external-gateway
      namespace: {{ $releaseNamespace }}
  hostnames:
    - {{ $service.name }}.local
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        {{- $shouldLoadBalance := $service.loadBalanceAcrossEndpoints | default true }}
        {{- if and $shouldLoadBalance (gt (len $service.endpoints) 1) }}
        {{- $endpointCount := len $service.endpoints }}
        {{- range $index, $endpoint := $service.endpoints }}
        - name: {{ $service.name }}-{{ $index }}
          port: {{ $service.port }}
          weight: {{ div 100 $endpointCount }}
        {{- end }}
        {{- else }}
        - name: {{ $service.name }}
          port: {{ $service.port }}
        {{- end }}
{{- end }}
{{- end }}